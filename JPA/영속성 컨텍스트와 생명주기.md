## 영속성 컨텍스트  

영속성 컨텍스트는 ```엔티티를 영구저장```하는 환경이다.
* 엔티티 매니저를 통해서 영속성 컨텍스트에 접근/관리할 수 있다
* persist() 메소드는 엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장하는 것이다.

## 생명주기

엔티티의 생명주기는 ```영속```, ```준영속```, ```비영속```, ```삭제``` 4가지이다.

### 1. 비영속

* 엔티티 객체를 생성 후 저장하지 않은 상태
* 따라서 영속성 컨텍스트와 데이터베이스와는 전혀 관련이 없음

### 2. 영속

* 엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트를 저장한 상태 → 엔티티매니저에 의해 관리되는 엔티티
* 하지만 데이터베이스에 저장된 상태는 아님

### 3. 준영속

* 영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 더이상 관리하지 않는 상태
* ```em.detach()```, ```em.close()```, ```em.clear()```로 준영속 상태로 변경 가능 
* 준영속 상태는 영속성 컨텍스트가 더이상 관리하지 않으므로 1차 캐시, 쓰기 지연, 변경 감지, 지연 로딩 등의 어떠한 기능도 동작하지 않음
* 준영속 상태는 이미 한번 영속 상태였기 때문에 반드시 식별자 값을 가지고 있음

![image](https://github.com/yaezzin/TIL/assets/97823928/768dd7a9-0b9b-4508-9a43-10ed6287c35c)


```준영속 상태 -> 영속 상태```
* 준영속 상태의 엔티티를 영속 상태로 변경하려면 merge()를 사용하면 된다.
  * 1. merge(엔티티)를 실행
  * 2. 파라미터로 넘어온 준영속 엔티티의식별자 값으로 1차 캐시에서 엔티티를 조회한다.
  * 2-1. 만약 1차 캐시에 없으면 DB에서 조회한 이후 1차 캐시에 저장
  * 3. 조회한 영속 엔티티(mergeMember)에 member 엔티티의 값을 넣고, mergeMember를 반환 


### 4. 삭제

* 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제하는 경우
